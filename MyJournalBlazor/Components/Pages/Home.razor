@page "/journal"
@using MyJournalBlazor.Models
@using MyJournalBlazor.Services
@using MudBlazor
@using System.Text.RegularExpressions

@inject IDatabaseService DbService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager

<div class="mt-4"></div>

<div class="@FontSizeClass">

    <!-- HEADER -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.EditNote" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4" Style="font-weight:bold;">Daily Entry</MudText>
        </div>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="SaveEntry"
                   Disabled="@isSaving"
                   StartIcon="@Icons.Material.Filled.Save">
            @if (isSaving)
            {
                <MudText>Saving...</MudText>
            }
            else
            {
                <MudText>Save</MudText>
            }
        </MudButton>
    </div>

    <!-- FORM -->
    <MudPaper Class="pa-6 mb-6" Elevation="3">
        <MudGrid>
            <!-- ROW 1 -->
            <MudItem xs="12" sm="6">
                <MudDatePicker Label="Select Date"
                               Date="selectedDate"
                               DateChanged="OnDateChanged"
                               Variant="Variant.Outlined"
                               Color="Color.Primary"
                               MaxDate="@DateTime.Today"
                               HelperText="No journaling for the future!" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect T="string"
                           Label="Primary Mood"
                           @bind-Value="currentEntry.Mood"
                           Variant="Variant.Outlined"
                           AnchorOrigin="Origin.BottomCenter"
                           AdornmentIcon="@Icons.Material.Filled.EmojiEmotions">
                    <MudSelectItem Value="@("Positive")">Positive</MudSelectItem>
                    <MudSelectItem Value="@("Neutral")">Neutral</MudSelectItem>
                    <MudSelectItem Value="@("Negative")">Negative</MudSelectItem>
                </MudSelect>
            </MudItem>

            <!-- ROW 2 -->
            <MudItem xs="12" sm="6">
                <MudSelect T="string"
                           Label="Secondary Moods (Max 2)"
                           MultiSelection="true"
                           SelectedValues="selectedSecMoods"
                           SelectedValuesChanged="OnSecMoodsChanged"
                           Variant="Variant.Outlined"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var mood in AvailableSecMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect T="string"
                           Label="Tags"
                           MultiSelection="true"
                           @bind-SelectedValues="selectedTags"
                           Variant="Variant.Outlined"
                           AnchorOrigin="Origin.BottomCenter"
                           AdornmentIcon="@Icons.Material.Filled.Label">
                    @foreach (var tag in AvailableTags)
                    {
                        <MudSelectItem Value="@tag">@tag</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- ROW 3 -->
            <MudItem xs="12">
                <MudTextField @bind-Value="currentEntry.Title" Label="Title" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- EDITOR -->
    <MudPaper Class="pa-4" Style="min-height: 450px;" Elevation="3">
        <MudText Typo="Typo.h6" Class="mb-3">Journal Content</MudText>
        <div class="@(IsDarkMode ? "dark-mode-quill" : "")">
            <div id="quill-editor" style="height: 350px;"></div>
        </div>
    </MudPaper>

</div>

@code {
    [CascadingParameter(Name = "IsDarkMode")]
    public bool IsDarkMode { get; set; }

    [CascadingParameter(Name = "FontSizeClass")]
    public string FontSizeClass { get; set; } = "font-medium";

    private JournalEntry currentEntry = new JournalEntry();
    private DateTime? selectedDate = DateTime.Today;

    private bool isEditorInitialized = false;
    private bool isSaving = false;

    // Dropdown Data
    private readonly string[] AvailableTags =
        { "Work", "Studies", "Family", "Health", "Fitness", "Travel", "Nature", "Finance", "Gaming", "Music" };

    private readonly string[] AvailableSecMoods =
        { "Happy", "Excited", "Relaxed", "Grateful", "Calm", "Bored", "Sad", "Angry", "Stressed", "Lonely" };

    // Selection Holders
    private IEnumerable<string> selectedTags { get; set; } = new HashSet<string>();
    private IEnumerable<string> selectedSecMoods { get; set; } = new HashSet<string>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadEntryForDate(DateTime.Today);
            isEditorInitialized = true;
        }
    }

    private async Task OnDateChanged(DateTime? newDate)
    {
        selectedDate = newDate;
        if (newDate.HasValue)
            await LoadEntryForDate(newDate.Value.Date);
    }

    // LIMIT SELECTION TO 2 MOODS
    private void OnSecMoodsChanged(IEnumerable<string> values)
    {
        var list = values?.ToList() ?? new List<string>();

        if (list.Count > 2)
        {
            Snackbar.Add("Max 2 secondary moods allowed!", Severity.Warning);
            selectedSecMoods = list.Take(2).ToList();
        }
        else
        {
            selectedSecMoods = list;
        }
    }

    private async Task LoadEntryForDate(DateTime date)
    {
        date = date.Date;

        var existing = await DbService.GetEntryByDateAsync(date);

        if (existing != null)
        {
            // EDIT MODE (load)
            currentEntry = existing;

            selectedTags = !string.IsNullOrWhiteSpace(currentEntry.Tags)
                ? currentEntry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(x => x.Trim()).ToList()
                : new HashSet<string>();

            selectedSecMoods = !string.IsNullOrWhiteSpace(currentEntry.SecondaryMoods)
                ? currentEntry.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(x => x.Trim()).ToList()
                : new HashSet<string>();

            Snackbar.Add($"Loaded entry for {date.ToShortDateString()}", Severity.Info);
        }
        else
        {
            currentEntry = new JournalEntry
            {
                Date = date,
                Mood = "Neutral",
                Title = "",
                Content = "",
                Tags = "",
                SecondaryMoods = ""
            };

            selectedTags = new HashSet<string>();
            selectedSecMoods = new HashSet<string>();
        }

        // Load into Quill
        if (isEditorInitialized)
            await JSRuntime.InvokeVoidAsync("quillInterop.setHtml", currentEntry.Content);
        else
            await JSRuntime.InvokeVoidAsync("quillInterop.init", "quill-editor", currentEntry.Content);
    }

    private async Task SaveEntry()
    {
        // max 2 moods
        if (selectedSecMoods.Count() > 2)
        {
            Snackbar.Add("Max 2 secondary moods allowed!", Severity.Error);
            return;
        }

        // Pull HTML from Quill
        string htmlContent = await JSRuntime.InvokeAsync<string>("quillInterop.getHtml");
        currentEntry.Content = htmlContent ?? "";

        // Validate title
        if (string.IsNullOrWhiteSpace(currentEntry.Title))
        {
            Snackbar.Add("Title is required!", Severity.Warning);
            return;
        }

        // Validate content (strip HTML)
        var plain = Regex.Replace(currentEntry.Content, "<.*?>", " ").Trim();
        if (string.IsNullOrWhiteSpace(plain))
        {
            Snackbar.Add("Content cannot be empty. Please write something.", Severity.Warning);
            return;
        }

        isSaving = true;
        StateHasChanged();
        await Task.Delay(300);

        // Convert List -> string for DB
        currentEntry.Tags = string.Join(",", (selectedTags ?? Array.Empty<string>()).Select(x => x.Trim()).Where(x => !string.IsNullOrWhiteSpace(x)));
        currentEntry.SecondaryMoods = string.Join(",", (selectedSecMoods ?? Array.Empty<string>()).Select(x => x.Trim()).Where(x => !string.IsNullOrWhiteSpace(x)));

        // Normalize date
        if (selectedDate.HasValue)
            currentEntry.Date = selectedDate.Value.Date;

        await DbService.SaveEntryAsync(currentEntry);

        Snackbar.Add("Saved! Redirecting...", Severity.Success);
        await Task.Delay(800);
        NavManager.NavigateTo("/history");

        isSaving = false;
    }
}