@page "/history"
@using MyJournalBlazor.Models
@using MyJournalBlazor.Services
@inject IDatabaseService DbService
@inject IDialogService DialogService

<div class="fade-in">
    <h1 class="mb-4">History</h1>

    <!-- Search Bar -->
    <div class="input-group mb-4 shadow-sm">
        <span class="input-group-text">Search</span>
        <input type="text" class="form-control" placeholder="Search entries..."
               @bind="searchText" @bind:event="oninput" @onkeyup="FilterEntries" />
    </div>

    @if (filteredEntries == null)
    {
        <p>Loading...</p>
    }
    else if (filteredEntries.Count == 0)
    {
        <div class="alert alert-info">No entries found. Go write one!</div>
    }
    else
    {
        <div class="journal-card">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Mood</th>
                        <th>Title</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in filteredEntries)
                    {
                        <tr>
                            <td>@item.Date.ToShortDateString()</td>
                            <td>
                                <span class="badge @GetMoodColor(item.Mood)">@item.Mood</span>
                            </td>
                            <td>@item.Title</td>
                            <td>
                                <!-- VIEW BUTTON -->
                                <button class="btn btn-outline-primary btn-sm me-2" @onclick="() => ViewEntry(item)">
                                    View
                                </button>

                                <!-- DELETE BUTTON -->
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteEntry(item)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<JournalEntry> allEntries = new List<JournalEntry>();
    private List<JournalEntry> filteredEntries = new List<JournalEntry>();
    private string searchText = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        allEntries = await DbService.GetEntriesAsync();
        filteredEntries = allEntries;
    }

    private void ViewEntry(JournalEntry item)
    {
        var parameters = new DialogParameters { ["Entry"] = item };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        DialogService.Show<Components.Dialogs.EntryDialog>("View Entry", parameters, options);
    }

    private async Task DeleteEntry(JournalEntry item)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Delete", "Delete this entry?", "Yes", "No");
        if (confirm)
        {
            await DbService.DeleteEntryAsync(item);
            await LoadEntries();
        }
    }

    private void FilterEntries()
    {
        if (string.IsNullOrWhiteSpace(searchText))
            filteredEntries = allEntries;
        else
            filteredEntries = allEntries.Where(x => x.Title.ToLower().Contains(searchText.ToLower())).ToList();
    }

    private string GetMoodColor(string mood)
    {
        return mood switch
        {
            "Positive" => "bg-success",
            "Negative" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}