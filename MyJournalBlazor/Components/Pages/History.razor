@page "/history"
@using System.IO
@using MyJournalBlazor.Models
@using MyJournalBlazor.Services
@using MudBlazor

@inject IDatabaseService DbService
@inject IDialogService DialogService
@inject Services.PdfService PdfService

<div class="fade-in">
    <div class="d-flex align-center gap-2 mb-4">
        <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" Color="Color.Primary" />
        <MudText Typo="Typo.h4" Style="font-weight:bold;">History</MudText>
    </div>

    <!-- MUD TABLE -->
    <MudTable Items="@allEntries" Hover="true" Filter="new Func<JournalEntry,bool>(FilterFunc)" Elevation="3" RowsPerPage="5">

        <ToolBarContent>
            <MudText Typo="Typo.h6">Past Entries</MudText>
            <MudSpacer />

            <MudDateRangePicker Label="Export Range"
                                @bind-DateRange="exportRange"
                                Variant="Variant.Outlined"
                                Color="Color.Primary"
                                Class="mr-4" />

            <!-- EXPORT BUTTON -->
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       OnClick="ExportPdf"
                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                       Class="mr-4">
                Export PDF
            </MudButton>

            <MudTextField @bind-Value="searchString" Placeholder="Search..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>

        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Moods</MudTh>
            <MudTh>Tags</MudTh>
            <MudTh>Title</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Date">@context.Date.ToShortDateString()</MudTd>

            <MudTd DataLabel="Moods">
                <!-- Primary Mood -->
                <MudChip T="string" Color="@GetMoodColor(context.Mood)" Size="Size.Small">@context.Mood</MudChip>

                <!-- Secondary Moods-->
                @if (!string.IsNullOrEmpty(context.SecondaryMoods))
                {
                    @foreach (var sm in context.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries))
                    {
                        <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">@sm</MudChip>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Tags">
                @if (!string.IsNullOrEmpty(context.Tags))
                {
                    @foreach (var tag in context.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                    {
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">#@tag</MudChip>
                    }
                }
            </MudTd>

            <MudTd DataLabel="Title">@context.Title</MudTd>

            <MudTd DataLabel="Actions">
                <!-- VIEW BUTTON -->
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Small"
                           Class="mr-2"
                           OnClick="() => ViewEntry(context)">
                    View
                </MudButton>

                <!-- DELETE BUTTON -->
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="() => DeleteEntry(context)">
                    Delete
                </MudButton>
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</div>

@code {
    private List<JournalEntry> allEntries = new List<JournalEntry>();
    private string searchString = "";
    private DateRange exportRange = new DateRange(DateTime.Today.AddDays(-30), DateTime.Today);

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        allEntries = await DbService.GetEntriesAsync();
    }

    private bool FilterFunc(JournalEntry entry)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;

        if ((entry.Title ?? "").Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if ((entry.Mood ?? "").Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if ((entry.Tags ?? "").Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;

        // Search CONTENT (strip HTML)
        var plain = System.Text.RegularExpressions.Regex.Replace(entry.Content ?? "", "<.*?>", " ");
        if (plain.Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;

        return false;
    }

    private void ViewEntry(JournalEntry item)
    {
        var parameters = new DialogParameters { ["Entry"] = item };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<Components.Dialogs.EntryDialog>("View Entry", parameters, options);
    }

    private async Task DeleteEntry(JournalEntry item)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Delete", "Delete this entry?", "Yes", "No");
        if (confirm)
        {
            await DbService.DeleteEntryAsync(item);
            await LoadEntries();
        }
    }

    private Color GetMoodColor(string mood) => mood switch
    {
        "Positive" => Color.Success,
        "Negative" => Color.Error,
        _ => Color.Warning
    };

    private async Task ExportPdf()
    {
        var start = (exportRange.Start ?? DateTime.MinValue).Date;
        var end = (exportRange.End ?? DateTime.Today).Date;

        // Don't allow exporting future days
        if (end > DateTime.Today) end = DateTime.Today;

        // Export only entries within the selected range AND matching the search filter
        var entriesToExport = allEntries
            .Where(e => e.Date.Date >= start && e.Date.Date <= end)
            .Where(e => FilterFunc(e))
            .ToList();

        if (entriesToExport.Count == 0)
        {
            await App.Current.MainPage.DisplayAlert("Export", "No entries in the selected range.", "OK");
            return;
        }

        var pdfBytes = PdfService.GeneratePdf(entriesToExport);

        string docsFolder = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        string fileName = $"Journal_Export_{start:yyyyMMdd}_to_{end:yyyyMMdd}.pdf";
        string filePath = Path.Combine(docsFolder, fileName);

        File.WriteAllBytes(filePath, pdfBytes);

        bool open = await App.Current.MainPage.DisplayAlert("Success",
            $"PDF saved to Documents folder.\n\nOpen it now?", "Yes", "No");

        if (open)
        {
            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(filePath)
            });
        }
    }
}